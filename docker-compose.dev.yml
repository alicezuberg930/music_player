services:
  # yukikaze_player_db:
  #   image: mysql:9
  #   container_name: yukikaze_player_db
  #   environment:
  #     MYSQL_DATABASE:
  #     MYSQL_HOST:
  #     MYSQL_PASSWORD:
  #     MYSQL_PORT:
  #     MYSQL_SSL_MODE:
  #     MYSQL_USER:
  #   env_file: .env
  #   ports:
  #     - "3306:3306"
  #   volumes:
  #     - yukikaze_player_db_data:/var/lib/mysql/data

  yukikaze_player_app_dev:
    build: 
      context: .
      dockerfile: apps/web/Dockerfile.development
      args:
        VITE_API_URL: ${VITE_API_URL}
        WEB_PORT: ${WEB_PORT}
    container_name: yukikaze_player_app
    ports:
      - "5173:5173"
    restart: unless-stopped
    env_file: .env
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5173/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    depends_on:
      yukikaze_player_song_dev:
        condition: service_healthy
      yukikaze_player_home_dev:
        condition: service_healthy
      yukikaze_player_gateway_dev:
        condition: service_healthy
      yukikaze_player_artist_dev:
        condition: service_healthy
      yukikaze_player_auth_dev:
        condition: service_healthy
      yukikaze_player_playlist_dev:
        condition: service_healthy
      yukikaze_player_banner_dev:
        condition: service_healthy
      yukikaze_player_user_dev:
        condition: service_healthy
      # yukikaze_player_db:
      #   condition: service_healthy
    develop:
      watch:
        - action: sync
          path: ./apps/web/src
          target: /app/apps/web/src
          ignore:
            - node_modules/
        - action: rebuild
          path: ./apps/web/package.json
        - action: sync
          path: ./packages
          target: /app/packages
          ignore:
            - node_modules/

  yukikaze_player_song_dev:
    build:
      context: .
      dockerfile: services/song-service/Dockerfile.development
    restart: unless-stopped
    env_file: .env
    container_name: yukikaze_player_song
    ports:
      - "5003:5003"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5003/check || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    depends_on:
      yukikaze_player_gateway_dev:
        condition: service_healthy
    develop:
      watch:
        - action: sync
          path: ./services/song-service/src
          target: /app/services/song-service/src
          ignore:
            - node_modules/
        - action: rebuild
          path: ./services/song-service/package.json
        - action: sync
          path: ./packages
          target: /app/packages
          ignore:
            - node_modules/

  yukikaze_player_home_dev:
    build:
      context: .
      dockerfile: services/home-service/Dockerfile.development
    restart: unless-stopped
    env_file: .env
    container_name: yukikaze_player_home
    ports:
      - "5001:5001"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5001/check || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    depends_on:
      yukikaze_player_gateway_dev:
        condition: service_healthy
    develop:
      watch:
        - action: sync
          path: ./services/home-service/src
          target: /app/services/home-service/src
          ignore:
            - node_modules/
        - action: rebuild
          path: ./services/home-service/package.json
        - action: sync
          path: ./packages
          target: /app/packages
          ignore:
            - node_modules/

  yukikaze_player_gateway_dev:
    build:
      context: .
      dockerfile: services/gateway-service/Dockerfile.development
    restart: unless-stopped
    env_file: .env
    environment:
      - HOME_SERVICE_HOST=yukikaze_player_home_dev
      - AUTH_SERVICE_HOST=yukikaze_player_auth_dev
      - SONG_SERVICE_HOST=yukikaze_player_song_dev
      - BANNER_SERVICE_HOST=yukikaze_player_banner_dev
      - ARTIST_SERVICE_HOST=yukikaze_player_artist_dev
      - PLAYLIST_SERVICE_HOST=yukikaze_player_playlist_dev
      - USER_SERVICE_HOST=yukikaze_player_user_dev
    container_name: yukikaze_player_gateway
    ports:
      - "5000:5000"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/check || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    develop:
      watch:
        - action: sync
          path: ./services/gateway-service/src
          target: /app/services/gateway-service/src
          ignore:
            - node_modules/
        - action: rebuild
          path: ./services/gateway-service/package.json
        - action: sync
          path: ./packages
          target: /app/packages
          ignore:
            - node_modules/

  yukikaze_player_artist_dev:
    build:
      context: .
      dockerfile: services/artist-service/Dockerfile.development
    restart: unless-stopped
    env_file: .env
    container_name: yukikaze_player_artist
    ports:
      - "5004:5004"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5004/check || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    depends_on:
      yukikaze_player_gateway_dev:
        condition: service_healthy
    develop:
      watch:
        - action: sync
          path: ./services/artist-service/src
          target: /app/services/artist-service/src
          ignore:
            - node_modules/
        - action: rebuild
          path: ./services/artist-service/package.json
        - action: sync
          path: ./packages
          target: /app/packages
          ignore:
            - node_modules/

  yukikaze_player_auth_dev:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile.development
    restart: unless-stopped
    env_file: .env
    container_name: yukikaze_player_auth
    ports:
      - "5002:5002"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5002/check || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    depends_on:
      yukikaze_player_gateway_dev:
        condition: service_healthy
    develop:
      watch:
        - action: sync
          path: ./services/auth-service/src
          target: /app/services/auth-service/src
          ignore:
            - node_modules/
        - action: rebuild
          path: ./services/auth-service/package.json
        - action: sync
          path: ./packages
          target: /app/packages
          ignore:
            - node_modules/

  yukikaze_player_banner_dev:
    build:
      context: .
      dockerfile: services/banner-service/Dockerfile.development
    restart: unless-stopped
    env_file: .env
    container_name: yukikaze_player_banner
    ports:
      - "5005:5005"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5005/check || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    depends_on:
      yukikaze_player_gateway_dev:
        condition: service_healthy
    develop:
      watch:
        - action: sync
          path: ./services/banner-service/src
          target: /app/services/banner-service/src
          ignore:
            - node_modules/
        - action: rebuild
          path: ./services/banner-service/package.json
        - action: sync
          path: ./packages
          target: /app/packages
          ignore:
            - node_modules/

  yukikaze_player_playlist_dev:
    build:
      context: .
      dockerfile: services/playlist-service/Dockerfile.development
    restart: unless-stopped
    env_file: .env
    container_name: yukikaze_player_playlist
    ports:
      - "5007:5007"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5007/check || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    depends_on:
      yukikaze_player_gateway_dev:
        condition: service_healthy
    develop:
      watch:
        - action: sync
          path: ./services/playlist-service/src
          target: /app/services/playlist-service/src
          ignore:
            - node_modules/
        - action: rebuild
          path: ./services/playlist-service/package.json
        - action: sync
          path: ./packages
          target: /app/packages
          ignore:
            - node_modules/

  yukikaze_player_user_dev:
    build:
      context: .
      dockerfile: services/user-service/Dockerfile.development
    restart: unless-stopped
    env_file: .env
    container_name: yukikaze_player_user
    ports:
      - "5006:5006"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5006/check || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    depends_on:
      yukikaze_player_gateway_dev:
        condition: service_healthy
    develop:
      watch:
        - action: sync
          path: ./services/user-service/src
          target: /app/services/user-service/src
          ignore:
            - node_modules/
        - action: rebuild
          path: ./services/user-service/package.json
        - action: sync
          path: ./packages
          target: /app/packages
          ignore:
            - node_modules/

  rabbitmq:
    image: rabbitmq:3-management
    container_name: yukikaze_player_rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"

  redis:
    image: redis:7-alpine
    container_name: yukikaze_player_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --save 60 1 --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    volumes:
      - yukikaze_player_redis_data:/data


volumes:
  yukikaze_player_redis_data:
    driver: local
  # yukikaze_player_db_data:
  # driver: local

# clean cache
# docker system prune -a --volumes

# Basic commands
# docker compose up                    # Start services in foreground
# docker compose up -d                 # Start services in detached mode (background)
# docker compose up --build            # Rebuild images before starting
# docker compose up -d --build         # Rebuild and start in background

# Scaling and selection
# docker compose up --scale SERVICE=NUM   # Scale a service to NUM instances
# docker compose up SERVICE1 SERVICE2     # Start specific services only
# docker compose up --profile PROFILE     # Start services with specific profile

# Build options
# docker compose up --no-build         # Don't build images, use existing
# docker compose up --force-recreate   # Recreate containers even if config unchanged
# docker compose up --no-recreate      # Don't recreate existing containers
# docker compose up --build --no-cache # Rebuild without using cache

# Output and logging
# docker compose up --quiet-pull       # Pull without printing progress
# docker compose up --no-log-prefix    # Don't print container name in logs
# docker compose up --timestamps       # Show timestamps in logs

# Resource management
# docker compose up --remove-orphans   # Remove containers for services not in compose file
# docker compose up --no-deps          # Don't start linked services
# docker compose up --abort-on-container-exit  # Stop all if any container stops

# Other useful combinations
# docker compose up -d --build --remove-orphans    # Full rebuild, background, cleanup
# docker compose up --build --force-recreate       # Force complete rebuild
# docker compose up --profile prod --build -d      # Production profile, build, detached